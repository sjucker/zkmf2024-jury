<div>
  <app-header header="ZKMF2024 - Jury"></app-header>
  <div class="loading-indicator">
    <mat-progress-bar mode="indeterminate" color="accent"
                      *ngIf="loading || saving"></mat-progress-bar>
  </div>
  <div class="max-width-container" *ngIf="report">
    <mat-accordion>
      <mat-expansion-panel expanded>
        <mat-expansion-panel-header>
          <mat-panel-title>{{report.verein}}</mat-panel-title>
        </mat-expansion-panel-header>
        <div>
          <span><b>Modul</b>: {{report.modul}}</span>
          <span *ngIf="report.klasse">, <b>Klasse</b>: {{report.klasse}}</span>
          <span *ngIf="report.besetzung">, <b>Besetzung</b>: {{report.besetzung}}</span>
        </div>
        <div><b>Wettspiellokal</b>: {{report.location}}</div>
        <div><b>Dirigent/in</b>: {{report.dirigent}}</div>
        <div *ngIf="report.programmTitel">
          <b>Programmtitel</b>: {{report.programmTitel}}
        </div>
        <div *ngIf="report.programmInfo">
          <b>Erläuterungen</b>: {{report.programmInfo}}
        </div>
        <div *ngIf="hasVorgabeDauer"><b>Vorgabe Dauer</b>:
          {{formatDuration(report.minDurationInSeconds)}} - {{formatDuration(report.maxDurationInSeconds)}}
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel *ngFor="let title of report.titles">
        <mat-expansion-panel-header>
          <mat-panel-title>{{title.titel.titelName}}<span *ngIf="title.titel.pflichtStueck">*</span></mat-panel-title>
        </mat-expansion-panel-header>
        <div>
          <div>
            <span>{{title.titel.composer}}</span>
            <span *ngIf="title.titel.arrangeur"> (Arrangeur: {{title.titel.arrangeur}})</span>
            <span *ngIf="title.titel.grad">, Grad: {{title.titel.grad}}</span>
            <span>, Dauer: {{formatDuration(title.titel.durationInSeconds)}}</span>
          </div>
          <mat-form-field appearance="outline">
            <mat-label>{{readOnly ? '' : 'Kurzbericht'}}</mat-label>
            <textarea matInput
                      cdkTextareaAutosize
                      #autosize="cdkTextareaAutosize"
                      cdkAutosizeMinRows="3"
                      cdkAutosizeMaxRows="6"
                      [disabled]="readOnly"
                      [(ngModel)]="title.comment"
                      (ngModelChange)="onChange()"></textarea>
          </mat-form-field>

          <div *ngFor="let rating of title.ratings">
            <app-report-rating [rating]="rating"
                               [readOnly]="readOnly"
                               (changed)="onChange()"></app-report-rating>
          </div>

          <div class="action-container" *ngIf="!readOnly">
            <app-action-button [processing]="saving"
                               [disabled]="!pendingChanges"
                               buttonLabel="Speichern"
                               (buttonClicked)="saveReport(report)"></app-action-button>
          </div>
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Gesamteindruck</mat-panel-title>
        </mat-expansion-panel-header>
        <div>
          <div *ngFor="let rating of report.overallRatings">
            <app-report-rating [rating]="rating"
                               [readOnly]="readOnly"
                               (changed)="onChange()"></app-report-rating>
          </div>

          <div class="action-container" *ngIf="!readOnly">
            <app-action-button [processing]="saving"
                               [disabled]="!pendingChanges"
                               buttonLabel="Speichern"
                               (buttonClicked)="saveReport(report)"></app-action-button>
          </div>
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Punktzahl & Abschliessen</mat-panel-title>
        </mat-expansion-panel-header>
        <div>
          <div class="overall-rating-container">
            <mat-form-field appearance="outline">
              <mat-label>min. 50 Punkte, max. 100 Punkte</mat-label>
              <input type="text"
                     autocomplete="off"
                     matInput
                     min="50"
                     max="100"
                     [disabled]="readOnly"
                     [(ngModel)]="report.score"
                     (ngModelChange)="onChange()"/>
            </mat-form-field>

            <ul>
              <li>90-100 Punkte für ausgezeichnete Leistungen</li>
              <li>80-89 Punkte für sehr gute Leistungen</li>
              <li>70-79 Punkte für gute Leistungen</li>
              <li>60-69 Punkte für genügende Leistungen</li>
              <li>50-59 Punkte für ungenügende Leistungen</li>
            </ul>
          </div>
          <div class="action-container" *ngIf="!readOnly">
            <app-action-button [processing]="saving"
                               [color]="undefined"
                               [disabled]="!pendingChanges"
                               buttonLabel="Speichern"
                               (buttonClicked)="saveReport(report)"></app-action-button>

            <app-action-button [processing]="finishing"
                               [disabled]="!valid"
                               buttonLabel="Abschliessen"
                               (buttonClicked)="finishReport(report)"></app-action-button>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>

  <div *ngIf="errorMessage" class="max-width-container error-msg">
    {{errorMessage}}
  </div>
</div>
